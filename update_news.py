import json
import random
import datetime
import asyncio
import edge_tts

# --- 1. æ ¸å¿ƒï¼šå¸å®‰ Alpha (ä¸¥æ ¼æ—¶é—´æ§åˆ¶) ---
def get_binance_alpha(hour):
    current_hour = int(hour)
    
    # ã€é“å¾‹ã€‘12ç‚¹å‰ï¼Œè¿”å›ç©ºï¼Œç»ä¸ç”Ÿæˆä»»ä½•å†…å®¹
    if current_hour < 12:
        return None 
    
    # 12ç‚¹åï¼Œç”Ÿæˆå…·ä½“çš„é¢†å–æƒ…æŠ¥
    claim_minute = random.choice(["12", "25", "38", "49"])
    points = random.choice([1000, 2500, 3000, 5000])
    
    return {
        "category": "Alpha",
        "tag": "ğŸ”¥ é‡ç‚¹",
        "title": "å¸å®‰ä»Šæ—¥ç©ºæŠ• Â· é¢†å–æé†’",
        "summary": f"å¿—ç²æé†’ä½ å“¦ï¼Œå¸å®‰ä¸­æ–‡æ¨ç‰¹åˆšåˆšæ›´æ–°å•¦ã€‚ä»Šå¤©çš„é¢†å–æ—¶é—´åœ¨ã€{current_hour}:{claim_minute}ã€‘ã€‚ç§¯åˆ†è¦æ±‚æ˜¯ {points} åˆ†ã€‚ä¸ç®¡å¿™ä¸å¿™ï¼Œé—¹é’Ÿä¸€å®šè¦å®šå¥½å‘¢ã€‚",
        "length": 80
    }

# --- 2. æµ·é‡å¸åœˆçƒ­ç‚¹ (æ‰©å®¹ç‰ˆ) ---
def get_crypto_news():
    # è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„è¯­æ–™åº“ï¼Œéšæœºç»„åˆ
    news_pool = [
        ("BTC å†²å‡» 10 ä¸‡åˆ€", "åå°”è¡—æœºæ„åƒç–¯äº†ä¸€æ ·åœ¨ä¹°å…¥ï¼ŒETF å‡€æµå…¥åˆåˆ›æ–°é«˜äº†ï¼Œçœ‹æ¥å¤§ç‰›å¸‚çœŸçš„ä¸è¿œäº†å‘¢ã€‚"),
        ("ä»¥å¤ªåŠ Gas è´¹é™è‡³å†°ç‚¹", "ç°åœ¨é“¾ä¸Šäº¤äº’çœŸçš„å¥½ä¾¿å®œï¼ŒVç¥è¯´è¿™æ˜¯ Layer2 çš„èƒœåˆ©ï¼Œå¤§å®¶å¯ä»¥è¶ç°åœ¨å¤šå»ä½“éªŒä¸€ä¸‹æ–°é¡¹ç›®ã€‚"),
        ("Solana é“¾ä¸Šé‡‘ç‹—é¢‘å‡º", "å¬è¯´æœ‰ä¸ªèªæ˜é’±åœ°å€ï¼Œä¸€æ™šä¸Šç”¨ 2 ä¸ª SOL èµšåˆ°äº† 100 ä¸‡ç¾é‡‘ï¼ŒçœŸçš„æ˜¯å¤ªç–¯ç‹‚äº†ã€‚"),
        ("ç¾è”å‚¨æš—ç¤ºå³å°†é™æ¯", "å®è§‚èµ„é‡‘é¢è¦æ”¾æ°´äº†ï¼Œé£é™©èµ„äº§çš„æ˜¥å¤©å°±è¦æ¥äº†ï¼Œå¤§å®¶æ‹¿å¥½æ‰‹é‡Œçš„ç­¹ç å“¦ã€‚"),
        ("å­™å®‡æ™¨åˆæœ‰å¤§åŠ¨ä½œ", "å­™å“¥åˆšåˆšå‘äº¤æ˜“æ‰€è½¬å…¥äº† 1 äº¿ USDTï¼Œæ¯æ¬¡ä»–ä¸€åŠ¨ï¼Œå¸‚åœºå°±è¦å‘ç”Ÿå¤§äº‹ï¼Œå¤§å®¶è¦å°å¿ƒæ³¢åŠ¨å“¦ã€‚"),
        ("Ordinals é“­æ–‡å¤è‹", "æ¯”ç‰¹å¸ç”Ÿæ€åˆå¼€å§‹çƒ­é—¹èµ·æ¥äº†ï¼Œå‡ ä¸ªå¤´éƒ¨é“­æ–‡åœ°æ¿ä»·éƒ½åœ¨æ¶¨ï¼Œçœ‹æ¥ç¤¾åŒºå…±è¯†è¿˜æ˜¯å¾ˆå¼ºçš„ã€‚"),
        ("Coinbase è´¢æŠ¥è¶…é¢„æœŸ", "åŠ å¯†è´§å¸æ­£åœ¨è¢«ä¸»æµä¸–ç•Œæ¥å—ï¼Œåˆè§„åŒ–çš„é“è·¯è™½ç„¶éš¾èµ°ï¼Œä½†å‰é€”ä¸€å®šæ˜¯å…‰æ˜çš„ã€‚"),
        ("æŸ DeFi åè®®é­é‡é»‘å®¢", "å®‰å…¨çœŸçš„å¾ˆé‡è¦å‘¢ï¼Œå¤§å®¶æˆæƒé’±åŒ…çš„æ—¶å€™ä¸€å®šè¦çœ‹æ¸…æ¥šï¼Œä¸è¦å› å°å¤±å¤§å“¦ã€‚"),
        ("é©¬æ–¯å…‹å†æ¬¡å–Šå• Doge", "ç‹—ç‹—å¸åº”å£°å¤§æ¶¨ 20%ï¼Œé¦–å¯Œçš„å¸¦è´§èƒ½åŠ›çœŸçš„æ˜¯ä¸å¾—ä¸æœå‘€ã€‚"),
        ("è´è±å¾· CEO å†æ¬¡åŠ›æŒº", "ä»–è¯´æ¯”ç‰¹å¸æ˜¯æ•°å­—é»„é‡‘ï¼Œæ˜¯é¢å¯¹é€šèƒ€æœ€å¥½çš„é¿é™©èµ„äº§ï¼Œçœ‹æ¥æœºæ„æ˜¯é“äº†å¿ƒè¦è¿›åœºäº†ã€‚")
    ]
    
    # éšæœºé€‰ 4 æ¡ï¼Œä¿è¯å†…å®¹ä¸°å¯Œ
    selected = random.sample(news_pool, 4)
    items = []
    for title, detail in selected:
        items.append({
            "category": "å¸åœˆ",
            "tag": random.choice(["è¡Œæƒ…", "çƒ­ç‚¹", "è§‚å¯Ÿ", "ä¸»è¦"]),
            "title": title,
            "summary": detail,
            "length": len(title) + len(detail)
        })
    return items

# --- 3. å¹¿æ’­ç¨¿ç”Ÿæˆ (æè‡´å¿—ç²é£) ---
def create_chiling_script(alpha, news_list, hour_str):
    # è¯­æ°”è¯ + æ…¢èŠ‚å¥
    text = f"å“ˆå–½å¤§å®¶å¥½å‘€ï¼Œç°åœ¨æ˜¯åŒ—äº¬æ—¶é—´ {hour_str} ç‚¹æ•´ã€‚æˆ‘æ˜¯ä½ ä»¬çš„ Web3 åŠ©ç†å¿—ç²ã€‚ "
    
    # A. å¦‚æœæœ‰ Alpha (ä¸‹åˆ/æ™šä¸Š)
    if alpha:
        text += f"é¦–å…ˆå‘¢ï¼Œæœ‰ä¸€ä¸ªè¶…çº§é‡è¦çš„æ¶ˆæ¯ã€‚{alpha['summary']} è¿™ä¸ªä¸€å®šè¦è®°ä½å“¦ã€‚ "
        text += "ç„¶åæ¥çœ‹çœ‹ä»Šå¤©çš„è¡Œæƒ…å§ã€‚ "
    # B. å¦‚æœæ²¡ Alpha (æ—©ä¸Š)
    else:
        text += "æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œæ¥çœ‹çœ‹å¸åœˆå‘ç”Ÿäº†ä»€ä¹ˆæ–°é²œäº‹å§ã€‚ "

    # æ’­æŠ¥æ™®é€šæ–°é—»
    for i, item in enumerate(news_list):
        # å¢åŠ è¿æ¥è¯ï¼Œæ›´è‡ªç„¶
        if i == 0: text += f"é¦–å…ˆæ˜¯ï¼Œ{item['title']}ã€‚{item['summary']} "
        elif i == len(news_list)-1: text += f"æœ€åä¸€æ¡ï¼Œ{item['title']}ã€‚{item['summary']} "
        else: text += f"è¿˜æœ‰å‘¢ï¼Œ{item['title']}ã€‚{item['summary']} "

    text += "å¥½å•¦ï¼Œä»¥ä¸Šå°±æ˜¯æœ¬æ—¶æ®µçš„å¿«è®¯ã€‚æŠ•èµ„æœ‰é£é™©ï¼Œå¤§å®¶è¦ä¿æŒç†æ€§å“¦ã€‚æˆ‘ä»¬ä¸‹ä¸ªæ•´ç‚¹è§ï¼Œæ‹œæ‹œ~"
    return text

# --- 4. éŸ³é¢‘ç”Ÿæˆ (è°ƒä¼˜ç‰ˆ) ---
async def generate_audio(text):
    print(f"ğŸ™ï¸ å¿—ç²å§å§å½•éŸ³ä¸­...")
    
    # å‚æ•°è°ƒä¼˜ï¼š
    # rate="-12%": è¯­é€Ÿå‡æ…¢ï¼Œæ›´æ¸©æŸ”
    # pitch="+2Hz": éŸ³è°ƒå¾®è°ƒï¼Œæ›´ç”œç¾
    # volume="+0%": ä¿æŒåŸéŸ³é‡
    try:
        communicate = edge_tts.Communicate(text, "zh-TW-HsiaoYuNeural", rate="-12%", pitch="+2Hz")
        await communicate.save("radio.mp3")
        print("âœ… radio.mp3 ç”ŸæˆæˆåŠŸ")
    except Exception as e:
        print(f"âŒ ç”Ÿæˆå¤±è´¥: {e}")

# --- ä¸»ç¨‹åº ---
if __name__ == "__main__":
    utc_now = datetime.datetime.utcnow()
    beijing_now = utc_now + datetime.timedelta(hours=8)
    today_str = beijing_now.strftime("%Y-%m-%d")
    hour_str = beijing_now.strftime("%H")
    
    # 1. è·å–æ•°æ®
    alpha = get_binance_alpha(hour_str)
    crypto_news = get_crypto_news()
    
    # 2. ç»„åˆåˆ—è¡¨ (ç”¨äºå‰ç«¯æ˜¾ç¤º)
    all_news = []
    if alpha: all_news
